<!DOCTYPE html>
<html lang="es" data-theme="{{ user_settings.theme if user_settings else 'dark' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster - Gestión de Tareas</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    {% if logged_in %}
    <!-- Dashboard cuando el usuario está logueado -->
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>TaskMaster</h2>
                <div class="header-controls">
                    <button id="theme-toggle" class="theme-btn" title="Cambiar tema">🌙</button>
                    <button id="notifications-btn" class="notification-btn" title="Notificaciones">
                        🔔
                        {% if unread_notifications > 0 %}
                        <span class="notification-badge">{{ unread_notifications }}</span>
                        {% endif %}
                    </button>
                    <button id="settings-btn" class="settings-btn" title="Configuraciones">⚙️</button>
                </div>
            </div>
            
            <!-- User Profile -->
            <div class="user-profile">
                <div class="user-avatar-container">
                    {% if user_avatar.has_custom %}
                    <img src="{{ url_for('uploaded_file', filename=user_avatar.filename) }}" 
                         alt="Avatar" class="user-avatar-img" id="user-avatar-display">
                    {% else %}
                    <div class="user-avatar" style="background-color: {{ avatar_color }}" id="user-avatar-display">
                        {{ user_initials }}
                    </div>
                    {% endif %}
                    <button class="upload-avatar-btn" id="upload-avatar-btn" title="Cambiar avatar">📷</button>
                </div>
                <div class="user-info">
                    <h3>{{ username }}</h3>
                    <p class="user-role">{{ user_role }}</p>
                    <div class="user-level">
                        <span class="level-badge">Nivel {{ user_points.level }}</span>
                        <div class="points">{{ user_points.points }} puntos</div>
                        <div class="rank">Ranking: #{{ user_ranking.rank if user_ranking.rank > 0 else 'N/A' }}</div>
                    </div>
                </div>
            </div>

            <!-- User Stats -->
            <div class="user-stats">
                <div class="stat-item">
                    <span class="stat-value">{{ user_stats.completed_tasks }}</span>
                    <span class="stat-label">Completadas</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{{ user_stats.active_tasks }}</span>
                    <span class="stat-label">Activas</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{{ user_stats.completion_rate }}%</span>
                    <span class="stat-label">Tasa Éxito</span>
                </div>
            </div>

            <!-- Quick Stats Chart -->
            <div class="quick-stats-chart">
                <canvas id="userStatsChart" width="200" height="100"></canvas>
            </div>

            <!-- Achievements -->
            {% if user_points.achievements %}
            <div class="achievements">
                <h4>Logros Recientes</h4>
                <div class="achievement-list">
                    {% for achievement in user_points.achievements[-3:] %}
                    <div class="achievement-item">
                        <span class="achievement-icon">{{ achievement.icon }}</span>
                        <span class="achievement-name">{{ achievement.name }}</span>
                    </div>
                    {% endfor %}
                    {% if user_points.achievements|length > 3 %}
                    <button class="view-all-achievements">Ver todos ({{ user_points.achievements|length }})</button>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Projects -->
            <div class="projects-section">
                <div class="projects-header">
                    <h4>Proyectos</h4>
                    {% if can_manage_projects %}
                    <div class="project-controls">
                        <button id="add-project-btn" class="add-project-btn" title="Nuevo proyecto">+</button>
                        {% if current_project %}
                        <button id="project-settings-btn" class="project-settings-btn" title="Configuraciones del proyecto">⚙️</button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="projects-list">
                    {% for project in projects %}
                    <a href="{{ url_for('select_project', project_id=project.id) }}" 
                       class="project-item {% if current_project and current_project.id == project.id %}active{% endif %}"
                       style="{% if current_project and current_project.id == project.id %}border-left: 4px solid {{ project.color if project.color else 'var(--primary-color)' }};{% endif %}">
                        <div class="project-color-dot" style="background-color: {{ project.color if project.color else 'var(--primary-color)' }}"></div>
                        {{ project.name }}
                        {% if current_project and current_project.id == project.id %}
                        <span class="project-indicator">📌</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>

            <!-- Quick Notes -->
            <div class="quick-notes-section">
                <div class="notes-header">
                    <h4>Notas Rápidas</h4>
                    <button id="add-note-btn" class="add-note-btn" title="Nueva nota">📝</button>
                </div>
                <div class="notes-list" id="notes-list">
                    <!-- Notes will be loaded here -->
                </div>
            </div>

            <!-- Mini Chat -->
            <div class="mini-chat-section">
                <div class="chat-header">
                    <h4>Chat del Proyecto</h4>
                    <button id="toggle-chat-btn" class="toggle-chat-btn" title="Mostrar/Ocultar">💬</button>
                </div>
                <div class="chat-container" id="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <!-- Chat messages will be loaded here -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chat-input" placeholder="Escribe un mensaje..." maxlength="200">
                        <button id="send-chat-btn" title="Enviar">📤</button>
                    </div>
                </div>
            </div>

            <!-- Rankings Preview -->
            <div class="rankings-preview">
                <h4>Top Usuarios</h4>
                <div class="top-users">
                    {% for ranking in global_rankings[:3] %}
                    <div class="top-user {% if ranking.username == username %}current-user{% endif %}">
                        <span class="rank">{{ ranking.rank }}.</span>
                        <span class="username">{{ ranking.username }}</span>
                        <span class="score">{{ ranking.monthly_score }}</span>
                    </div>
                    {% endfor %}
                </div>
                <button id="view-rankings-btn" class="view-rankings-btn">Ver Rankings Completos</button>
            </div>

            <div class="sidebar-footer">
                <a href="{{ url_for('logout') }}" class="logout-btn">Cerrar Sesión</a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            {% if current_project %}
            <!-- Top Control Bar -->
            <div class="control-bar">
                <div class="control-section">
                    <div class="search-container">
                        <input type="text" id="task-search" placeholder="🔍 Buscar tareas, usuarios o estados..." class="search-input">
                        <div class="search-filters">
                            <button class="filter-btn" data-filter="all">Todas</button>
                            <button class="filter-btn" data-filter="assigned">Asignadas a mí</button>
                            <button class="filter-btn" data-filter="urgent">Urgentes</button>
                            <button class="filter-btn" data-filter="today">Hoy</button>
                        </div>
                    </div>
                </div>
                
                <div class="view-controls">
                    <div class="view-switcher">
                        <button class="view-btn active" data-view="kanban" title="Vista Kanban">📋</button>
                        <button class="view-btn" data-view="calendar" title="Vista Calendario">📅</button>
                        <button class="view-btn" data-view="dashboard" title="Dashboard">📊</button>
                    </div>
                    
                    <div class="action-buttons">
                        {% if can_edit_tasks %}
                        <button id="add-task-btn" class="action-btn primary">+ Nueva Tarea</button>
                        {% endif %}
                        <button id="export-image-btn" class="action-btn" title="Exportar como imagen">📸</button>
                        <button id="project-analytics-btn" class="action-btn" title="Estadísticas">📈</button>
                    </div>
                </div>
            </div>

            <div class="project-header">
                <div class="project-title">
                    <div class="project-color-indicator" style="background-color: {{ current_project.color if current_project.color else 'var(--primary-color)' }}"></div>
                    <h1>{{ current_project.name }}</h1>
                    <div class="project-theme-badge" style="background: {{ current_project.color if current_project.color else 'var(--primary-color)' }}">
                        {{ current_project.theme_name if current_project.theme_name else 'Tema por defecto' }}
                    </div>
                </div>
                <div class="quick-stats">
                    <div class="stat">
                        <span class="stat-number">{{ tasks.todo|length + tasks.inprogress|length + tasks.done|length }}</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number">{{ tasks.done|length }}</span>
                        <span class="stat-label">Completadas</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number">{{ (tasks.done|length / (tasks.todo|length + tasks.inprogress|length + tasks.done|length) * 100)|round if (tasks.todo|length + tasks.inprogress|length + tasks.done|length) > 0 else 0 }}%</span>
                        <span class="stat-label">Progreso</span>
                    </div>
                </div>
            </div>

            <!-- Project Progress Bar -->
            <div class="project-progress">
                {% set total_tasks = tasks.todo|length + tasks.inprogress|length + tasks.done|length %}
                {% set completed_tasks = tasks.done|length %}
                {% set progress_percent = (completed_tasks / total_tasks * 100) if total_tasks > 0 else 0 %}
                <div class="progress-info">
                    <span>Progreso del Proyecto: {{ completed_tasks }}/{{ total_tasks }} tareas</span>
                    <span>{{ "%.1f"|format(progress_percent) }}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ progress_percent }}%"></div>
                </div>
            </div>

            <!-- Views Container -->
            <div class="views-container">
                <!-- Kanban View -->
                <div class="view-content kanban-view active" data-view="kanban">
                    <div class="kanban-board" id="kanban-board">
                        {% set column_names = {'todo': 'Por hacer', 'inprogress': 'En curso', 'done': 'Finalizado'} %}
                        {% set visible_columns = project_settings.columns if project_settings else ['todo', 'inprogress', 'done'] %}
                        
                        {% for column in visible_columns %}
                        <div class="kanban-column" data-column="{{ column }}">
                            <div class="column-header {{ column }}-header">
                                <h3>{{ column_names[column] }}</h3>
                                <span class="task-count">{{ tasks[column]|length }}</span>
                            </div>
                            <div class="tasks-container" id="{{ column }}-tasks">
                                {% for task in tasks[column] %}
                                <div class="task-card {% if column == 'done' %}completed{% endif %}" 
                                     data-task-id="{{ task.id }}" 
                                     data-assigned="{{ task.assigned_to if task.assigned_to else '' }}"
                                     data-tags="{{ task.tags|join(',') if task.tags else '' }}"
                                     data-due-date="{{ task.due_date if task.due_date else '' }}"
                                     draggable="true">
                                    <div class="task-content">
                                        <div class="task-header">
                                            <div class="task-tags">
                                                {% if task.tags %}
                                                    {% for tag in task.tags %}
                                                    <span class="task-tag {{ tag.type if tag.type else 'default' }}">{{ tag.name }}</span>
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                            {% if task.due_date %}
                                            <div class="task-due-date {% if task.is_overdue %}overdue{% elif task.is_due_today %}due-today{% endif %}">
                                                📅 {{ task.due_date }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <p>{{ task.text }}</p>
                                        <div class="task-meta">
                                            <div class="task-author-section">
                                                <span class="task-author">{{ task.created_by }}</span>
                                                {% if task.assigned_to and task.assigned_to != task.created_by %}
                                                <span class="task-assigned">→ {{ task.assigned_to }}</span>
                                                {% endif %}
                                            </div>
                                            <span class="task-date">{{ task.created_at }}</span>
                                        </div>
                                    </div>
                                    <div class="task-actions">
                                        <button class="comment-btn" data-task-id="{{ task.id }}" title="Comentarios">💬</button>
                                        <div class="reaction-buttons">
                                            <button class="reaction-btn" data-task-id="{{ task.id }}" data-emoji="👍" title="Me gusta">👍</button>
                                            <button class="reaction-btn" data-task-id="{{ task.id }}" data-emoji="🟢" title="Aprobado">🟢</button>
                                            <button class="reaction-btn" data-task-id="{{ task.id }}" data-emoji="🔴" title="Problema">🔴</button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Calendar View -->
                <div class="view-content calendar-view" data-view="calendar">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button id="prev-month" class="calendar-nav">‹</button>
                            <h3 id="current-month">Octubre 2024</h3>
                            <button id="next-month" class="calendar-nav">›</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Calendar will be generated by JavaScript -->
                        </div>
                        <div class="calendar-legend">
                            <div class="legend-item">
                                <span class="legend-dot" style="background: var(--todo-color)"></span>
                                <span>Por hacer</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: var(--inprogress-color)"></span>
                                <span>En curso</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: var(--done-color)"></span>
                                <span>Finalizado</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard View -->
                <div class="view-content dashboard-view" data-view="dashboard">
                    <div class="dashboard-container">
                        <div class="dashboard-widgets">
                            <!-- Today's Tasks -->
                            <div class="widget today-tasks">
                                <h3>📅 Tareas de Hoy</h3>
                                <div class="widget-content" id="today-tasks-list">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Progress Overview -->
                            <div class="widget progress-overview">
                                <h3>📊 Progreso Semanal</h3>
                                <div class="widget-content">
                                    <canvas id="weeklyProgressChart" width="300" height="200"></canvas>
                                </div>
                            </div>

                            <!-- Active Projects -->
                            <div class="widget active-projects">
                                <h3>🚀 Proyectos Activos</h3>
                                <div class="widget-content">
                                    {% for project in projects %}
                                    <div class="project-summary">
                                        <div class="project-info">
                                            <div class="project-color-dot" style="background: {{ project.color if project.color else 'var(--primary-color)' }}"></div>
                                            <span class="project-name">{{ project.name }}</span>
                                        </div>
                                        <div class="project-stats">
                                            {% set project_tasks = tasks if current_project and current_project.id == project.id else {} %}
                                            {% if project_tasks %}
                                            <span class="stat">{{ project_tasks.done|length }}/{{ project_tasks.todo|length + project_tasks.inprogress|length + project_tasks.done|length }}</span>
                                            {% else %}
                                            <span class="stat">0/0</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Team Performance -->
                            <div class="widget team-performance">
                                <h3>👥 Rendimiento del Equipo</h3>
                                <div class="widget-content">
                                    <div class="team-stats">
                                        <div class="team-member">
                                            <div class="member-info">
                                                <div class="member-avatar" style="background: #667eea">{{ user_initials }}</div>
                                                <span class="member-name">{{ username }}</span>
                                            </div>
                                            <div class="member-stats">
                                                <span class="tasks-completed">{{ user_stats.completed_tasks }} completadas</span>
                                                <span class="completion-rate">{{ user_stats.completion_rate }}% eficiencia</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Activity -->
                            <div class="widget recent-activity">
                                <h3>🔔 Actividad Reciente</h3>
                                <div class="widget-content" id="recent-activity-list">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="widget quick-actions">
                                <h3>⚡ Acciones Rápidas</h3>
                                <div class="widget-content">
                                    <div class="quick-action-buttons">
                                        <button class="quick-action-btn" data-action="add-task">
                                            <span class="action-icon">➕</span>
                                            <span class="action-text">Nueva Tarea</span>
                                        </button>
                                        <button class="quick-action-btn" data-action="add-project">
                                            <span class="action-icon">📁</span>
                                            <span class="action-text">Nuevo Proyecto</span>
                                        </button>
                                        <button class="quick-action-btn" data-action="add-note">
                                            <span class="action-icon">📝</span>
                                            <span class="action-text">Nueva Nota</span>
                                        </button>
                                        <button class="quick-action-btn" data-action="export">
                                            <span class="action-icon">📊</span>
                                            <span class="action-text">Exportar</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="welcome-screen">
                <h1>Bienvenido a TaskMaster</h1>
                <p>Selecciona un proyecto o crea uno nuevo para comenzar a gestionar tus tareas.</p>
                {% if can_manage_projects %}
                <button id="add-project-btn" class="create-first-project-btn">Crear mi primer proyecto</button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Upload Avatar Modal -->
    <div id="upload-avatar-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Cambiar Avatar</h2>
            <form id="upload-avatar-form" enctype="multipart/form-data">
                <div class="avatar-upload-zone">
                    <input type="file" id="avatar-file" name="avatar" accept="image/*" style="display: none;">
                    <div class="upload-placeholder" id="upload-placeholder">
                        <div class="upload-icon">📷</div>
                        <p>Haz clic para seleccionar una imagen</p>
                        <p class="upload-info">Formatos: JPG, PNG, GIF (máx. 5MB)</p>
                    </div>
                    <div class="avatar-preview" id="avatar-preview" style="display: none;">
                        <img id="preview-image" src="" alt="Vista previa">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" id="remove-avatar-btn" class="secondary-btn">Usar iniciales</button>
                    <button type="submit">Guardar Avatar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal large-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Configuraciones</h2>
            <div class="settings-tabs">
                <button class="tab-btn active" data-tab="general">General</button>
                <button class="tab-btn" data-tab="appearance">Apariencia</button>
                <button class="tab-btn" data-tab="notifications">Notificaciones</button>
                <button class="tab-btn" data-tab="security">Seguridad</button>
            </div>
            
            <div class="settings-content">
                <!-- General Tab -->
                <div id="general-settings" class="tab-content active">
                    <h3>Configuraciones Generales</h3>
                    <form id="general-settings-form">
                        <div class="form-group">
                            <label>Idioma</label>
                            <select name="language">
                                <option value="es" selected>Español</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Zona Horaria</label>
                            <select name="timezone">
                                <option value="America/Mexico_City" selected>Ciudad de México (GMT-6)</option>
                                <option value="America/New_York">Nueva York (GMT-5)</option>
                                <option value="Europe/Madrid">Madrid (GMT+1)</option>
                            </select>
                        </div>
                    </form>
                </div>

                <!-- Appearance Tab -->
                <div id="appearance-settings" class="tab-content">
                    <h3>Apariencia</h3>
                    <form id="appearance-settings-form">
                        <div class="form-group">
                            <label>Tema</label>
                            <div class="theme-options">
                                <label class="radio-option">
                                    <input type="radio" name="theme" value="light" 
                                           {% if user_settings.theme == 'light' %}checked{% endif %}>
                                    <span>🌞 Claro</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="theme" value="dark" 
                                           {% if user_settings.theme == 'dark' %}checked{% endif %}>
                                    <span>🌙 Oscuro</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="theme" value="auto">
                                    <span>🔄 Automático</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Colores Personalizados</label>
                            <div class="color-inputs">
                                <div class="color-input">
                                    <label>Color Primario</label>
                                    <input type="color" name="primary_color" 
                                           value="{{ user_settings.custom_colors.primary if user_settings else '#667eea' }}">
                                </div>
                                <div class="color-input">
                                    <label>Color Secundario</label>
                                    <input type="color" name="secondary_color" 
                                           value="{{ user_settings.custom_colors.secondary if user_settings else '#764ba2' }}">
                                </div>
                                <div class="color-input">
                                    <label>Por hacer</label>
                                    <input type="color" name="todo_color" 
                                           value="{{ user_settings.custom_colors.todo if user_settings else '#ff6b6b' }}">
                                </div>
                                <div class="color-input">
                                    <label>En curso</label>
                                    <input type="color" name="inprogress_color" 
                                           value="{{ user_settings.custom_colors.inprogress if user_settings else '#feca57' }}">
                                </div>
                                <div class="color-input">
                                    <label>Finalizado</label>
                                    <input type="color" name="done_color" 
                                           value="{{ user_settings.custom_colors.done if user_settings else '#48cae4' }}">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Notifications Tab -->
                <div id="notifications-settings" class="tab-content">
                    <h3>Notificaciones</h3>
                    <form id="notifications-settings-form">
                        <div class="form-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="email_notifications" 
                                       {% if user_settings.notifications.email_enabled %}checked{% endif %}>
                                <span>Notificaciones por email</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="task_move_notifications" 
                                       {% if user_settings.notifications.task_moves %}checked{% endif %}>
                                <span>Cuando alguien mueve mis tareas</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="project_notifications" 
                                       {% if user_settings.notifications.project_updates %}checked{% endif %}>
                                <span>Actualizaciones de proyectos</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="achievement_notifications" 
                                       {% if user_settings.notifications.achievements %}checked{% endif %}>
                                <span>Nuevos logros y medallas</span>
                            </label>
                        </div>
                    </form>
                </div>

                <!-- Security Tab -->
                <div id="security-settings" class="tab-content">
                    <h3>Seguridad</h3>
                    <div class="security-section">
                        <h4>Cambiar Contraseña</h4>
                        <form id="change-password-form">
                            <div class="form-group">
                                <input type="password" name="current_password" placeholder="Contraseña actual" required>
                            </div>
                            <div class="form-group">
                                <input type="password" name="new_password" placeholder="Nueva contraseña" required>
                            </div>
                            <div class="form-group">
                                <input type="password" name="confirm_password" placeholder="Confirmar nueva contraseña" required>
                            </div>
                            <button type="submit" class="security-btn">Cambiar Contraseña</button>
                        </form>
                    </div>
                    <div class="security-section">
                        <h4>Verificación en Dos Pasos</h4>
                        <p class="security-info">Agrega una capa extra de seguridad a tu cuenta</p>
                        <button class="security-btn secondary" disabled>Configurar 2FA (Próximamente)</button>
                    </div>
                    <div class="security-section">
                        <h4>Pregunta de Seguridad</h4>
                        <p class="security-info">Para recuperar tu cuenta en caso de olvido</p>
                        <button class="security-btn secondary" disabled>Configurar Pregunta (Próximamente)</button>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="secondary-btn" data-action="close">Cancelar</button>
                <button type="button" id="save-settings-btn">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Notifications Panel -->
    <div id="notifications-panel" class="side-panel">
        <div class="panel-header">
            <h3>Notificaciones</h3>
            <button class="close-panel">&times;</button>
        </div>
        <div class="panel-content">
            <div id="notifications-list">
                {% for notification in notifications %}
                <div class="notification-item {% if not notification.read %}unread{% endif %}" 
                     data-id="{{ notification.id }}">
                    <div class="notification-icon {{ notification.type }}">
                        {% if notification.type == 'success' %}✅{% elif notification.type == 'warning' %}⚠️{% elif notification.type == 'error' %}❌{% else %}ℹ️{% endif %}
                    </div>
                    <div class="notification-content">
                        <p>{{ notification.message }}</p>
                        <span class="notification-time">{{ notification.timestamp }}</span>
                    </div>
                    {% if not notification.read %}
                    <button class="mark-read-btn" data-id="{{ notification.id }}">✓</button>
                    {% endif %}
                </div>
                {% endfor %}
                {% if not notifications %}
                <div class="no-notifications">
                    <p>No hay notificaciones</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Project Settings Modal -->
    <div id="project-settings-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Configuraciones del Proyecto</h2>
            <form id="project-settings-form">
                <div class="form-group">
                    <label>Columnas Visibles</label>
                    <div class="checkbox-group">
                        <label class="checkbox-option">
                            <input type="checkbox" name="columns" value="todo" 
                                   {% if not project_settings or 'todo' in project_settings.columns %}checked{% endif %}>
                            <span>Por hacer</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="columns" value="inprogress" 
                                   {% if not project_settings or 'inprogress' in project_settings.columns %}checked{% endif %}>
                            <span>En curso</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="columns" value="done" 
                                   {% if not project_settings or 'done' in project_settings.columns %}checked{% endif %}>
                            <span>Finalizado</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ordenar tareas por</label>
                    <select name="task_order">
                        <option value="created_date" 
                                {% if not project_settings or project_settings.task_order == 'created_date' %}selected{% endif %}>
                            Fecha de creación
                        </option>
                        <option value="priority" 
                                {% if project_settings and project_settings.task_order == 'priority' %}selected{% endif %}>
                            Prioridad
                        </option>
                        <option value="assigned" 
                                {% if project_settings and project_settings.task_order == 'assigned' %}selected{% endif %}>
                            Asignado
                        </option>
                    </select>
                </div>
                <button type="submit">Guardar Configuraciones</button>
            </form>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="add-project-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Crear Nuevo Proyecto</h2>
            <form id="add-project-form">
                <input type="text" id="project-name" placeholder="Nombre del proyecto" required>
                <button type="submit">Crear Proyecto</button>
            </form>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="add-task-modal" class="modal large-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Nueva Tarea</h2>
            <form id="add-task-form">
                <div class="form-group">
                    <label>Descripción de la tarea</label>
                    <textarea id="task-text" placeholder="Describe tu tarea..." required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Asignar a</label>
                        <select id="task-assigned-to">
                            <option value="">Sin asignar</option>
                            <option value="admin">Admin (Administración)</option>
                            <option value="maria">María (Desarrollo)</option>
                            <option value="juan">Juan (Soporte)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha límite</label>
                        <input type="date" id="task-due-date">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Etiquetas</label>
                    <div class="tags-input-container">
                        <div class="selected-tags" id="selected-tags"></div>
                        <input type="text" id="tags-input" placeholder="Agregar etiqueta (presiona Enter)">
                    </div>
                    <div class="predefined-tags">
                        <span class="predefined-tag urgent" data-tag="Urgente">Urgente</span>
                        <span class="predefined-tag bug" data-tag="Bug">Bug</span>
                        <span class="predefined-tag feature" data-tag="Feature">Feature</span>
                        <span class="predefined-tag review" data-tag="Revisión">Revisión</span>
                        <span class="predefined-tag client" data-tag="Cliente">Cliente</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Prioridad</label>
                    <div class="priority-options">
                        <label class="radio-option">
                            <input type="radio" name="priority" value="low" checked>
                            <span class="priority-indicator low">🟢 Baja</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="priority" value="medium">
                            <span class="priority-indicator medium">🟡 Media</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="priority" value="high">
                            <span class="priority-indicator high">🔴 Alta</span>
                        </label>
                    </div>
                </div>
                
                <button type="submit">Crear Tarea</button>
            </form>
        </div>
    </div>

    <!-- Quick Notes Modal -->
    <div id="add-note-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Nueva Nota Rápida</h2>
            <form id="add-note-form">
                <div class="form-group">
                    <input type="text" id="note-title" placeholder="Título de la nota" required>
                </div>
                <div class="form-group">
                    <textarea id="note-content" placeholder="Contenido de la nota..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Color de la nota</label>
                    <div class="note-colors">
                        <div class="note-color-option" data-color="#feca57" style="background: #feca57"></div>
                        <div class="note-color-option" data-color="#ff6b6b" style="background: #ff6b6b"></div>
                        <div class="note-color-option" data-color="#48cae4" style="background: #48cae4"></div>
                        <div class="note-color-option" data-color="#96ceb4" style="background: #96ceb4"></div>
                        <div class="note-color-option" data-color="#ff9ff3" style="background: #ff9ff3"></div>
                        <div class="note-color-option selected" data-color="#ffeaa7" style="background: #ffeaa7"></div>
                    </div>
                </div>
                <button type="submit">Crear Nota</button>
            </form>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>⚡ Atajos de Teclado</h2>
            <div class="shortcuts-list">
                <div class="shortcut-item">
                    <div class="shortcut-key">N</div>
                    <div class="shortcut-desc">Nueva tarea</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-key">Ctrl + F</div>
                    <div class="shortcut-desc">Buscar tareas</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-key">Ctrl + K</div>
                    <div class="shortcut-desc">Cambiar vista (Kanban/Calendario)</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-key">T</div>
                    <div class="shortcut-desc">Cambiar tema</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-key">Ctrl + E</div>
                    <div class="shortcut-desc">Exportar proyecto</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-key">Esc</div>
                    <div class="shortcut-desc">Cerrar modal/panel</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-key">?</div>
                    <div class="shortcut-desc">Mostrar atajos</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Comments Modal -->
    <div id="comments-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Comentarios de la Tarea</h2>
            <div id="task-details">
                <div id="task-title"></div>
                <div id="task-info"></div>
            </div>
            <div id="comments-container">
                <!-- Comments will be loaded here -->
            </div>
            <div class="add-comment">
                <form id="add-comment-form">
                    <input type="hidden" id="comment-task-id">
                    <textarea id="comment-text" placeholder="Agregar un comentario..." required></textarea>
                    <button type="submit">Comentar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal large-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Estadísticas del Proyecto</h2>
            <div class="analytics-tabs">
                <button class="tab-btn active" data-tab="overview">Resumen</button>
                <button class="tab-btn" data-tab="trends">Tendencias</button>
                <button class="tab-btn" data-tab="performance">Rendimiento</button>
            </div>
            <div class="analytics-content">
                <div id="overview-analytics" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-tasks-stat">{{ tasks.todo|length + tasks.inprogress|length + tasks.done|length }}</div>
                            <div class="stat-label">Total Tareas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completed-tasks-stat">{{ tasks.done|length }}</div>
                            <div class="stat-label">Completadas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="active-tasks-stat">{{ tasks.todo|length + tasks.inprogress|length }}</div>
                            <div class="stat-label">Activas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completion-rate-stat">
                                {% set total = tasks.todo|length + tasks.inprogress|length + tasks.done|length %}
                                {% if total > 0 %}{{ "%.0f"|format(tasks.done|length / total * 100) }}%{% else %}0%{% endif %}
                            </div>
                            <div class="stat-label">Tasa Completado</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="taskDistributionChart"></canvas>
                    </div>
                </div>
                <div id="trends-analytics" class="tab-content">
                    <div class="period-selector">
                        <button class="period-btn active" data-period="weekly">Semanal</button>
                        <button class="period-btn" data-period="monthly">Mensual</button>
                        <button class="period-btn" data-period="yearly">Anual</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
                <div id="performance-analytics" class="tab-content">
                    <div class="performance-metrics">
                        <div class="metric">
                            <label>Productividad Semanal</label>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 75%"></div>
                            </div>
                            <span>75%</span>
                        </div>
                        <div class="metric">
                            <label>Tiempo Promedio por Tarea</label>
                            <div class="metric-value">2.3 días</div>
                        </div>
                        <div class="metric">
                            <label>Tareas por Semana</label>
                            <div class="metric-value">{{ user_ranking.weekly_completed if user_ranking else 0 }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rankings Modal -->
    <div id="rankings-modal" class="modal large-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Rankings de Usuarios</h2>
            <div class="rankings-content">
                <div class="rankings-table">
                    <div class="ranking-header">
                        <span>Posición</span>
                        <span>Usuario</span>
                        <span>Puntuación</span>
                        <span>Tareas/Semana</span>
                    </div>
                    <div id="rankings-list">
                        <!-- Rankings will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Login Screen -->
    <div class="login-container">
        <div class="login-box">
            <h1>TaskMaster</h1>
            <p>Gestiona tus tareas de manera eficiente</p>
            <form id="login-form">
                <div class="form-group">
                    <input type="text" id="username" name="username" placeholder="Usuario" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" name="password" placeholder="Contraseña" required>
                </div>
                <button type="submit">Iniciar Sesión</button>
                <div id="login-error" class="error-message"></div>
            </form>
            <div class="demo-users">
                <p>Usuarios de prueba:</p>
                <p><strong>admin</strong> / 1234 (Administrador)</p>
                <p><strong>maria</strong> / 1234 (Miembro)</p>
                <p><strong>juan</strong> / 1234 (Invitado)</p>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    {% if logged_in %}
    <script>
        // Initialize charts and data
        document.addEventListener('DOMContentLoaded', function() {
            // Set theme colors based on user settings
            {% if user_settings %}
            document.documentElement.style.setProperty('--primary-color', '{{ user_settings.custom_colors.primary }}');
            document.documentElement.style.setProperty('--secondary-color', '{{ user_settings.custom_colors.secondary }}');
            document.documentElement.style.setProperty('--todo-color', '{{ user_settings.custom_colors.todo }}');
            document.documentElement.style.setProperty('--inprogress-color', '{{ user_settings.custom_colors.inprogress }}');
            document.documentElement.style.setProperty('--done-color', '{{ user_settings.custom_colors.done }}');
            {% endif %}
            
            // Initialize user stats chart
            initializeUserStatsChart();
            
            // Initialize theme toggle
            initializeThemeToggle();
            
            // Add some demo notifications for new users
            {% if not notifications %}
            addDemoNotifications();
            {% endif %}
        });
        
        function initializeUserStatsChart() {
            const ctx = document.getElementById('userStatsChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completadas', 'Activas'],
                        datasets: [{
                            data: [{{ user_stats.completed_tasks }}, {{ user_stats.active_tasks }}],
                            backgroundColor: ['#48cae4', '#ff6b6b'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }
        
        function addDemoNotifications() {
            // Add welcome notification for demo
            setTimeout(() => {
                showNotification('¡Bienvenido a TaskMaster! 🎉', 'success');
            }, 1000);
        }
    </script>
    {% endif %}
</body>
</html>